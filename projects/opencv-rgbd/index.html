<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Depth Fusion for Large Scale Environments | Akash Sharma </title> <meta name="author" content="Akash Sharma"> <meta name="description" content="Implementation of Spatial Hashing in OpenCV RGBD"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/fonts/cmu_bright/cmun-bright.css?8de6f75d2d23db1acb89a80b1a718be9"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%A8%E2%80%8D%F0%9F%8E%93&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://akashsharma02.github.io/projects/opencv-rgbd/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> <script src="/assets/js/scramble.js"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">
      {
            "title": "Depth Fusion for Large Scale Environments",
            "description": "Implementation of Spatial Hashing in OpenCV RGBD",
            "published": "July 25, 2020",
            "authors": [
              
              {
                "author": "Akash Sharma",
                "authorURL": "/",
                "affiliations": [
                  {
                    "name": "The Robotics Insitute, CMU",
                    "url": ""
                  }
                ]
              }
              
            ],
            "katex": {
              "delimiters": [
                {
                  "left": "$",
                  "right": "$",
                  "display": false
                },
                {
                  "left": "$$",
                  "right": "$$",
                  "display": true
                }
              ]
            }
          }
    </script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Akash</span> Sharma </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/resume.pdf"> cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Depth Fusion for Large Scale Environments</h1> <p>Implementation of Spatial Hashing in OpenCV RGBD</p> </d-title> <d-byline></d-byline> <d-article> <p>This project aimed to implement spatial hashing for the TSDF volume data structure in the OpenCV RGBD module, and leverage the same to build a scalable submap based online 3D scene reconstruction system with little to no drift.</p> <p>TSDF volumes are widely agreed upon in the research community to be locally consistent with minimal drift, therefore a natural mapping model is a PoseGraph[2] of overlapping submaps, each representing a local section of the entire scene. This mapping model allows for periodic global optimization, which corrects accumulating drift retrospectively in the model, as new sensor measurements are incorporated.</p> <p>The following delineates the pipeline:</p> <div class="row"> <div class="col-sm mt-3 mt-md-0" align="center"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/opencv-large-kinfu-pipeline-480.webp 480w,/assets/img/opencv-large-kinfu-pipeline-800.webp 800w,/assets/img/opencv-large-kinfu-pipeline-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/opencv-large-kinfu-pipeline.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" title="KinectFusion Pipeline" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Module Pipeline </div> <p>This implementation uses the existing Kinect Fusion[1] pipeline in OpenCV.</p> <h2 id="implementation">Implementation</h2> <p>A sample demo of the application is as shown below, running on the ICL-NUIM dataset:</p> <div class="l-body" align="center"><iframe width="560" height="315" src="https://www.youtube.com/embed/F-SPHREIcAU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div> <p>The implementation in OpenCV contains the following primitives.</p> <h3 id="hash-table-based-tsdf-volume">Hash-table based TSDF volume</h3> <p>This implementation is based on the seminal work on Voxel hashing<d-cite key="niessner2013real"></d-cite>. A regular TSDF volume represents a scene as a 3D volume grid of (truncated) signed distance functions. These truncated signed distance functions are simply the shortest distance of each point to its closest surface. While this is simple to implement, this constrains a user to reconstruct scenes of limited size, since the volume size has to be preallocated.</p> <p>The Hash based volume, stores the volume as an <code class="language-plaintext highlighter-rouge">unordered_map</code> of smaller TSDF volume units (<code class="language-plaintext highlighter-rouge">volumeUnits</code>), each representing canonically 8<sup>3</sup> or 16<sup>3</sup> resolution. These volume units are indexed by a 3 dimensional Vector, which is hashed appropriately to minimise the number of hash collisions<d-cite key="boostcombine"></d-cite>.</p> <p>This TSDF volume requires the following important functionalities:</p> <ul> <li> <p><strong>Integration:</strong> During Integration, the TSDF volume automatically allocates new volume units, checking for existing volume units in the current viewing camera frustrum. Integration follows by delegating the task to individual volume units parallely, once the list of volume units to be integrated has been determined.</p> </li> <li> <p><strong>Raycasting:</strong> Raycasting is required to render the TSDF volume into a virtual image, that is used for tracking. Typically, for each pixel of the to-be generated image, a ray is marched in the volume with fixed steps to obtain an estimated surface distance measurement. In the <code class="language-plaintext highlighter-rouge">HashTSDFVolume</code> we get significant performance improvements since we can skip/jump over volume units (typically around 16 voxels length) that are away from the surface.</p> </li> </ul> <p>The following PR provides a CPU implementation of Hash-table TSDF volume in OpenCV:</p> <h3 id="submap">Submap</h3> <p>The submap class is an abstraction over the <code class="language-plaintext highlighter-rouge">hashTSDF</code> volume to support the <code class="language-plaintext highlighter-rouge">large_kinfu</code> pipeline. Some questions that are especially relevant with submap based 3D reconstruction are:</p> <ul> <li>What is the appropriate size of the submap volume?</li> <li>When do you terminate and initialize a new submap?</li> <li>How do you track and create constraints between multiple submaps in a scene for downstream optimization of poses?</li> </ul> <p>We address question 1. and 2. by using a camera overlap metric, which states that if the current camera frame consistently views - for a threshold number of frames - a new set of volume units that are only allocated recently and haven’t been part of the older frames, then it means that the camera must have moved to a new part of the scene.[4] Once a new submap is instantiated, we initialize it with a submap \(SE(3)\) pose of the frame at which it was created.</p> <p>We maintain a list of active submaps, all of which are simultaneously tracked at each time-step. The simultaneous tracking provides us with a camera pose w.r.t each submap as \(\mathbf{T}^t_{s_i c}\) where \(s_i\) represents the \(i^{th}\) submap coordinate frame, \(c\) represents the camera coordinate frame and \(t\) represents the current time-step. The relative constraint at each time-step between submap \(s_j\) and \(s_i\) can be obtained as:</p> \[\mathbf{T}^t_{s_j s_i} = {\mathbf{T}^t_{s_i c}}^{-1} \circ \mathbf{T}^t_{s_j c}\] <p>A robust estimate of the constraints between submaps over multiple timesteps is then obtained using a simple implementation of Iteratively Reweighted Least Squares (IRLS), which eliminates outlier constraint estimates using the Huber norm<d-cite key="kahler2016real"></d-cite>.</p> <h3 id="posegraph-optimization">PoseGraph optimization</h3> <p>Once we have a scene containing dynamically created submaps, we are required to optimize the submap poses to eliminate accumulating camera tracking drift and improved reconstruction</p> <p>We implement a simple <code class="language-plaintext highlighter-rouge">PoseGraph</code> class, and implement second order optimization methods such as <em>Gauss Newton</em>, and <em>Levenberg Marquardt</em>.</p> <p>The idea here is to abstract the submaps as nodes of 3D \(SE(3)\) poses, and to use the sensor measurements i.e., the robust Pose Constraints between submaps, as obtained from the previous section to correct the pose estimates. For a given submap pair \(s_j\) and \(s_i\) with an existing pose constraint \(\hat{\mathbf{T}}_{s_j s_i}\), we formulate an error metric (factor) as follows:</p> \[r = \hat{\mathbf{T}}_{s_j s_i} \ominus (\mathbf{T}_{s_i c} \ominus \mathbf{T}_{s_j c})\] <p>Where \(\ominus\) denotes the \(SE(3)\) right composition i.e., \(\mathbf{A} \ominus \mathbf{B} \triangleq \text{Log}(\mathbf{B}^{-1} \circ \mathbf{A})\)<d-cite key="sola2018micro"></d-cite></p> <p>We minimize the residual rr﻿ by linearizing the function and then solving the linear system of equations using a <em>Cholesky</em> solver or a <em>QR</em> solver. (We leverage <code class="language-plaintext highlighter-rouge">Eigen</code> library for the linear system solver).<d-cite key="dellaert2017factor"></d-cite></p> <p><strong>NOTE:</strong> Currently, the implementation of <em>Levenberg Marquardt</em> is unstable, and thus for the time being <code class="language-plaintext highlighter-rouge">Ceres</code> library is used for the same<d-cite key="agarwal2012ceres"></d-cite>. However, we will refine the implementation of the optimizer to make the module dependency-free in the future.</p> <p>The following Pull Request implements the <code class="language-plaintext highlighter-rouge">Submap</code> and <code class="language-plaintext highlighter-rouge">PoseGraph</code> optimization:</p> <h2 id="extensions-and-future-work">Extensions and Future Work</h2> <p>A large omission in this work is the Relocalization module that is imperative to prevent spurious creation of submaps when the camera revisits previously created submap sections. I plan to add this extension after GSoC.</p> <p>Typically <em>relocalization</em> modules are implemented using <em>Fast Bag of Words</em> or <em>Dynamic Bag of Words (FBoW, DBoW2/3)</em> <d-cite key="galvez2012bags"></d-cite> methods, which maintain a vocabulary of distinct keyframes as bag of words which can be quickly queried during tracking to detect cases of loop closure and can be used for camera relocalization if tracking fails.</p> <h2 id="acknowledgements">Acknowledgements</h2> <p>It has been very pleasant working with my mentor <em>Rostislav Vasilikhin</em>, (and with <em>Mihai Bujanca</em>), who was enthusiastic and forthcoming with all the issues during the 3 months of Google Summer of Code. It was especially rewarding and pedagogic implementing modules that form the basis of most Dense SLAM systems today, and the added benefit of making a significant open-source contribution in the process has made summer of 2020 worthwhile and interesting.</p> <p>I would like to thank Google for giving me this opportunity as well!</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/opencv-rgbd.bib"></d-bibliography> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Akash Sharma. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: July 19, 2024. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> </body> </html>